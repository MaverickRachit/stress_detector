<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Stress Monitor 2.0</title>
  
  <!-- 1. Import Chart.js for animated graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- 2. Use the Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /*
     * ========================================
     * NEW STYLING (Glassmorphism, Gradients, Animations)
     * ========================================
    */
    :root {
      --bg: #020617; /* Dark Navy Blue */
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --accent: #22d3ee; /* Cyan */
      
      --good: #4ade80;
      --warn: #facc15;
      --bad: #f87171;
    }
    
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      /* Subtle gradient background */
      background-image: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.15), transparent 50%),
                        radial-gradient(circle at 80% 90%, rgba(139, 92, 246, 0.1), transparent 50%);
      background-attachment: fixed;
    }
    
    .wrap {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 24px;
    }
    
    /* Main Dashboard Grid */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 1024px) {
      .dashboard {
        grid-template-columns: 2fr 1fr;
      }
    }
    .main-col, .side-col {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Glassmorphism Card Style */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 24px;
      box-shadow: 0 8px 32px rgba(2, 6, 23, 0.3);
      transition: all 0.3s ease;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }
    
    /* Config & Connect */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      align-items: flex-end;
    }
    label {
      display: block;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    input[type=number], button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: rgba(0, 0, 0, 0.2);
      color: var(--text);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
    }
    button.primary {
      background: var(--accent);
      color: var(--bg);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(34, 211, 238, 0.2);
      transition: all 0.2s ease;
      border: none;
    }
    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(34, 211, 238, 0.3);
    }
    button:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Vitals Card */
    .vitals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    .vital {
      text-align: center;
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
    }
    .vital-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .vital-value {
      font-size: 40px;
      font-weight: 800;
      color: var(--text);
      line-height: 1;
    }
    .vital-value span { font-size: 18px; font-weight: 500; color: var(--text-muted); margin-left: 4px; }
    
    /* Animated Heart Icon */
    .heart-icon {
      width: 24px;
      height: 24px;
      fill: var(--bad);
      animation: beat 1s infinite ease-in-out;
      /* Animation duration will be set by JS */
    }
    @keyframes beat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* Status Card */
    .status-box {
      background: rgba(0, 0, 0, 0.15);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .status-box #statusText {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: 1px;
    }
    .status-box #count {
      font-size: 64px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
    }
    .status-box #count span {
      font-size: 20px;
      font-weight: 500;
      color: var(--text-muted);
    }

    /* Result Card */
    #finalLevel {
      font-size: 32px;
      font-weight: 800;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      color: #000;
      text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    /* Gradient backgrounds for stress levels */
    .level-LOW { background: linear-gradient(90deg, var(--good), #86efac); }
    .level-MODERATE { background: linear-gradient(90deg, var(--warn), #fde047); }
    .level-HIGH { background: linear-gradient(90deg, var(--bad), #fca5a5); }

    #suggestList li {
      background: rgba(0, 0, 0, 0.15);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 15px;
      line-height: 1.6;
    }
    
    /* Breathing Pacemaker */
    .breather {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .breather-circle {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, var(--accent), #818cf8);
      border-radius: 50%;
      display: grid;
      place-items: center;
      color: var(--bg);
      font-size: 20px;
      font-weight: 600;
      /* 5s inhale, 5s exhale = 10s cycle */
      animation: breathe 10s infinite ease-in-out;
    }
    .breather-text {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-muted);
    }
    @keyframes breathe {
      0%   { transform: scale(0.6); opacity: 0.7; }
      50%  { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.6); opacity: 0.7; }
    }
    
    /* History List */
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    .history-item {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--card-border);
      font-size: 14px;
    }
    .history-item:last-child { border: none; }
    .history-item span { font-weight: 600; color: var(--text); }
    .history-level-LOW { color: var(--good); }
    .history-level-MODERATE { color: var(--warn); }
    .history-level-HIGH { color: var(--bad); }

  </style>
</head>
<body>
  
  <div class="wrap">
    
    <!-- Header -->
    <header class="card">
      <h1 style="display: flex; align-items: center; gap: 12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.997.001A3 3 0 0 0 12 5zm0 14a3 3 0 1 0-5.997.001A3 3 0 0 0 12 19zm0-7a3 3 0 1 0 5.997-.001A3 3 0 0 0 12 12zm0 0V5m0 7v7m0-7h7.5m-7.5 7H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2.5"/><path d="M5 12h2.5m14 0h-7.5"/><path d="M9 19v-2.34a2.26 2.26 0 0 1 .9-1.8L12 13l-2.1-1.86a2.26 2.26 0 0 1-.9-1.8V7"/></svg>
        Stress Monitor 2.0
      </h1>
      <div id="bleStatus" style="color: var(--text-muted); font-weight: 500;">
        Status: <span style="color: var(--bad); font-weight: 600;">Disconnected</span>
      </div>
    </header>

    <!-- Main Dashboard -->
    <div class="dashboard">

      <!-- Left Column -->
      <div class="main-col">
        
        <!-- Config Card -->
        <div class="card">
          <div class="config-grid">
            <div>
              <label for="roomTemp">Room Temperature (Â°C)</label>
              <input id="roomTemp" type="number" min="10" max="45" value="30">
            </div>
            <div>
              <label for="irThreshold">IR Threshold (Sensor Tuning)</label>
              <input id="irThreshold" type="number" min="1000" max="200000" value="20000">
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="startBtn" class="primary">Connect & Start Test</button>
            </div>
          </div>
        </div>
        
        <!-- Live Vitals Card -->
        <div class="card">
          <div class="vitals-grid">
            <!-- Heart Rate -->
            <div class="vital">
              <div class="vital-label">
                <svg class="heart-icon" id="heartIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                Heart Rate
              </div>
              <div id="valHR" class="vital-value">--<span>bpm</span></div>
            </div>
            <!-- SpO2 -->
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h3l3-9 3 18 3-9h3"/><path d="M19 10a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z"/></svg>
                SpOâ
              </div>
              <div id="valSp" class="vital-value">--<span>%</span></div>
            </div>
            <!-- GSR -->
            <div class="vital">
              <div class="vital-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                GSR (Avg)
              </div>
              <div id="valGSR" class="vital-value">--</div>
            </div>
          </div>
        </div>

        <!-- Charts Card -->
        <div class="card">
          <div class="card-title">Live Sensor Data</div>
          <div style="height: 250px;">
            <canvas id="hrChart"></canvas>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div style="height: 200px;"><canvas id="spChart"></canvas></div>
            <div style="height: 200px;"><canvas id="gsrChart"></canvas></div>
          </div>
        </div>
      </div>
      
      <!-- Right Column -->
      <div class="side-col">
        
        <!-- Status Card -->
        <div class="card">
          <div class="card-title">Status</div>
          <div class="status-box">
            <div id="statusText">IDLE</div>
            <div id="count">0<span>s</span></div>
          </div>
        </div>
        
        <!-- Results Card -->
        <div class="card" id="results-card">
          <div class="card-title">Analysis & Suggestions</div>
          <div id="finalLevel" class="">--</div>
          <ol id="suggestList" style="padding-left: 20px;"></ol>
        </div>

        <!-- Breathing Tool Card (Initially hidden) -->
        <div class="card" id="breather-card" style="display: none;">
          <div class="card-title">Calming Exercise</div>
          <div class="breather">
            <div class="breather-circle" id="breather-circle-text">Inhale...</div>
            <div class="breather-text">Follow the circle for 1 minute.</div>
          </div>
        </div>

      </div>

    </div>

    <!-- Session History Card -->
    <div class="card" style="margin-top: 24px;">
      <div class="card-title">Session History (Last 10)</div>
      <ul class="history-list" id="history-list">
        <!-- JS will populate this -->
      </ul>
    </div>

  </div>

<script>
/*
 * ========================================
 * UPGRADED JAVASCRIPT (Chart.js, BLE, History)
 * ========================================
*/

// --- BLE UUIDs (Must match ESP32) ---
const SERVICE_UUID      = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const CHAR_DATA_UUID    = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const CHAR_COMMAND_UUID = "a88a02e0-8422-42b0-a555-5203361a832a";

// --- Global BLE Objects ---
let bleDevice = null;
let gattServer = null;
let dataCharacteristic = null;
let commandCharacteristic = null;
const textDecoder = new TextDecoder('utf-8');
const textEncoder = new TextEncoder();

// --- UI Elements ---
const startBtn = document.getElementById('startBtn');
const bleStatusText = document.getElementById('bleStatus');
const statusText = document.getElementById('statusText');
const countText = document.getElementById('count');
const finalLevelText = document.getElementById('finalLevel');
const valHR = document.getElementById('valHR');
const valSp = document.getElementById('valSp');
const valGSR = document.getElementById('valGSR');
const suggestList = document.getElementById('suggestList');
const heartIcon = document.getElementById('heartIcon');
const breatherCard = document.getElementById('breather-card');
const breatherCircleText = document.getElementById('breather-circle-text');
const historyList = document.getElementById('history-list');

// --- Upgraded Suggestions (with Emojis) ---
const suggestions = {
  LOW: [
    "ð **You're in a calm state.** Great job! Keep up the mindful practices.",
    "ð§ **Stay hydrated.** Even mild dehydration can affect your mood. Grab some water.",
    "ð§ **Maintain good posture.** Sit up straight, relax your shoulders. It makes a difference.",
    "ð¶ââï¸ **Take a short walk.** A 5-10 minute walk can help maintain this positive state."
  ],
  MODERATE: [
    "â ï¸ **Slightly elevated stress.** Let's try to manage this before it builds up.",
    "ð¨ **Try 4-7-8 Breathing:** Inhale for 4s, hold for 7s, exhale slowly for 8s. Repeat 3 times.",
    "ð¤¸ââï¸ **Stretch it out.** Roll your neck and shoulders. Stand up and touch your toes.",
    "ð§ **Listen to calming music.** Put on a favorite playlist or some ambient sounds for 5 minutes.",
    "ð³ **Look at nature.** If you can, look out the window at a tree or the sky. It helps."
  ],
  HIGH: [
    "ð **High stress detected.** Please pause what you're doing. Your well-being is the priority.",
    "ð¬ï¸ **Focus on your breath NOW.** Use the breathing tool below. Just follow the circle.",
    "ð§ **Ground yourself (5-4-3-2-1):** Name 5 things you see, 4 things you feel, 3 things you hear, 2 you smell, 1 you taste.",
    "ðââï¸ **Change your environment.** If possible, step outside or go to a different room for a few minutes.",
    "ð£ï¸ **Talk to someone.** If this feeling persists, please reach out to a friend, family member, or professional."
  ]
};

// --- Chart.js Setup ---
const MAX_CHART_POINTS = 30;
let hrChart, spChart, gsrChart;

function createCharts() {
  const chartConfig = (label, color) => ({
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: label,
        data: [],
        borderColor: color,
        borderWidth: 3,
        pointRadius: 0,
        tension: 0.4,
        fill: true,
        backgroundColor: (ctx) => {
          const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
          gradient.addColorStop(0, `${color}80`); // 50% opacity
          gradient.addColorStop(1, `${color}00`); // 0% opacity
          return gradient;
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 500, easing: 'easeOutQuart' },
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { 
          display: true, 
          ticks: { color: 'var(--text-muted)' },
          grid: { color: 'var(--card-border)' }
        }
      }
    }
  });

  hrChart = new Chart(document.getElementById('hrChart'), chartConfig('Heart Rate', '#f87171'));
  spChart = new Chart(document.getElementById('spChart'), chartConfig('SpO2', '#22d3ee'));
  gsrChart = new Chart(document.getElementById('gsrChart'), chartConfig('GSR', '#facc15'));
  
  // Customize SpO2 chart range
  spChart.options.scales.y.min = 85;
  spChart.options.scales.y.max = 100;
}

function updateChart(chart, value) {
  if (value === 0 || value === -1) return; // Don't plot zeroes
  chart.data.labels.push('');
  chart.data.datasets[0].data.push(value);
  
  if (chart.data.labels.length > MAX_CHART_POINTS) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update('none'); // 'none' for smooth live updates
}

// --- Web Bluetooth Logic ---

startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;
  
  try {
    // 1. If not connected, request and connect
    if (!bleDevice || !bleDevice.gatt.connected) {
      setBLEStatus('Requesting device...', 'var(--warn)');
      statusText.textContent = 'CONNECTING';

      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ services: [SERVICE_UUID] }],
        optionalServices: [SERVICE_UUID]
      });
      
      bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      setBLEStatus('Connecting to device...', 'var(--warn)');
      gattServer = await bleDevice.gatt.connect();

      setBLEStatus('Getting Service...', 'var(--warn)');
      const service = await gattServer.getPrimaryService(SERVICE_UUID);

      setBLEStatus('Getting Characteristics...', 'var(--warn)');
      dataCharacteristic = await service.getCharacteristic(CHAR_DATA_UUID);
      commandCharacteristic = await service.getCharacteristic(CHAR_COMMAND_UUID);
      
      await dataCharacteristic.startNotifications();
      dataCharacteristic.addEventListener('characteristicvaluechanged', handleDataNotification);
      
      setBLEStatus('Connected', 'var(--good)');
      startBtn.textContent = 'Start 40s Test';
    }

    // 3. Send the "Start" command
    statusText.textContent = 'STARTING';
    const temp = parseInt(document.getElementById('roomTemp').value || '30');
    const irThr = parseInt(document.getElementById('irThreshold').value || '20000');
    
    // Clear UI for new test
    finalLevelText.textContent = '--';
    finalLevelText.className = '';
    suggestList.innerHTML = '';
    breatherCard.style.display = 'none';
    
    // Reset charts
    [hrChart, spChart, gsrChart].forEach(chart => {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
    });

    const command = JSON.stringify({ roomTemp: temp, irThreshold: irThr });
    await commandCharacteristic.writeValue(textEncoder.encode(command));
    
    statusText.textContent = 'MEASURING';

  } catch (error) {
    console.error('BLE Error:', error);
    setBLEStatus(`Error: ${error.name}`, 'var(--bad)');
    if (bleDevice) bleDevice.gatt.disconnect();
  } finally {
    startBtn.disabled = false;
  }
});

// Main data handler
function handleDataNotification(event) {
  const jsonString = textDecoder.decode(event.target.value);
  
  try {
    const data = JSON.parse(jsonString);

    const hr = data.hr || 0;
    const spo2 = data.spo2 || -1;
    const gsr = data.gsr || 0;

    // Update Live Vitals
    valHR.textContent = hr > 0 ? hr.toFixed(0) : '--';
    valSp.textContent = spo2 > 0 ? spo2 : '--';
    valGSR.textContent = gsr > 0 ? gsr.toFixed(0) : '--';
    
    // Update live heart animation
    if (hr > 40) {
      heartIcon.style.animationDuration = `${(60 / hr).toFixed(2)}s`;
    }

    // Update Live Charts
    updateChart(hrChart, hr);
    updateChart(spChart, spo2);
    updateChart(gsrChart, gsr);

    statusText.textContent = data.status || 'UNKNOWN';

    if (data.status === "MEASURING") {
      countText.textContent = data.timeLeft ? Math.ceil(data.timeLeft / 1000) : '0';
    }

    // Handle the final "DONE" packet
    if (data.status === "DONE") {
      countText.textContent = 0;
      const level = data.finalLevel || 'ERROR';
      finalLevelText.textContent = level;
      finalLevelText.className = `level-${level}`;
      
      // Show suggestions
      showSuggestions(level);
      
      // Show breather tool if stressed
      if (level === 'HIGH' || level === 'MODERATE') {
        breatherCard.style.display = 'block';
        startBreatherAnimation();
      }
      
      // Save to history
      saveSession({
        level: level,
        hr: data.hr.toFixed(0),
        spo2: data.spo2,
        gsr: data.gsr.toFixed(0),
        date: new Date().toLocaleString()
      });
    }

  } catch (error) {
    console.error('Error parsing JSON:', jsonString, error);
  }
}

function onDisconnected() {
  setBLEStatus('Disconnected', 'var(--bad)');
  statusText.textContent = 'IDLE';
  countText.textContent = '0';
  
  bleDevice = null;
  startBtn.textContent = 'Connect & Start Test';
}

function setBLEStatus(message, color) {
  const span = bleStatusText.querySelector('span');
  span.textContent = message;
  span.style.color = color;
}

function showSuggestions(level) {
  const list = suggestions[level] || [];
  suggestList.innerHTML = list.map(item => `<li>${item}</li>`).join('');
}

// Breathing animation text
function startBreatherAnimation() {
  breatherCircleText.textContent = 'Inhale...';
  setTimeout(() => {
    breatherCircleText.textContent = 'Exhale...';
  }, 5000); // Half of the 10s animation
  // Loop
  setInterval(() => {
    breatherCircleText.textContent = 'Inhale...';
    setTimeout(() => {
      breatherCircleText.textContent = 'Exhale...';
    }, 5000);
  }, 10000);
}

// --- Session History (localStorage) ---
const HISTORY_KEY = 'stressHistory';
const MAX_HISTORY = 10;

function saveSession(sessionData) {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  history.unshift(sessionData); // Add to the front
  
  if (history.length > MAX_HISTORY) {
    history = history.slice(0, MAX_HISTORY);
  }
  
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
  if (history.length === 0) {
    historyList.innerHTML = `<li style="color: var(--text-muted); text-align: center; padding: 20px;">No sessions recorded yet.</li>`;
    return;
  }
  
  historyList.innerHTML = history.map(item => `
    <li class="history-item">
      <div><span class="history-level-${item.level}">${item.level}</span></div>
      <div>HR: <span>${item.hr}</span></div>
      <div>SpOâ: <span>${item.spo2}%</span></div>
      <div style="color: var(--text-muted); font-size: 12px;">${item.date}</div>
    </li>
  `).join('');
}

// --- Initial Load ---
window.addEventListener('load', () => {
  createCharts();
  renderHistory();
});

</script>
</body>
</html>

